---
title: "Scenario analysis for healthcare needs for COVID-19 in Georgia"
author: "Andreas Handel (ahandel@uga.edu), John M. Drake (jdrake@uga.edu)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
  - \usepackage{amsmath}
output:
  html_document:
    df_print: paged
  pdf_document: default
bibliography: ["COVID-GA.bib"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, warning=FALSE)
today <- Sys.Date()
library(purrr)
library(knitr)
library(dplyr)
library(flextable)
library(xtable)
```


```{r loaddata, include=FALSE}
# pull data directly from github repo
# data is generated by stochastic GA simulator

# data is a list of lists
# main list contains a sub-list for each scenario
# each sub-list contains n data frames, each data frame is the time-series for a simulation
#scenariofile = 'https://raw.githubusercontent.com/CEIDatUGA/ncov-wuhan-stochastic-model/master/Georgia_scenarios_-_Sheet1.csv?token=ABQMQXYOBV7TFRDQXWX2YQC6PEFIU'
simfile = "simresults.rds" 
scenariofile <- 'Georgia scenarios - Sheet1.csv'
sims <- readRDS(simfile)
scenarios = read.csv(scenariofile)
startdate = sims$startdate
```


```{r styles}
#source('style-definitions.R')
```

## Introduction

The following produces predictions for health care needs in GA for COVID-19.
The basis for this is a transmission simulation model, which is described here:
http://2019-coronavirus-tracker.com/stochastic-GA.html

The transmission simulation model is run for different intervention scenarios. Output from this model is further processed here to produce estimates for health care needs in GA.


## Assumptions

Below are assumptions with high and low values for different quantities that go into the model predictions.

### Age structure for GA

We use census data for population data (https://www.census.gov/quickfacts/GA). 
Total population 10.6M, 23.8% individuals under 18, 13.9% above 65.
This age stratification is used below for risk calcuations.

```{r parameters-1, include=FALSE}
#age structure of population
#https://www.census.gov/quickfacts/GA
Ntot = 10617423
Nc = 0.238*Ntot #under 18
Ne = 0.139*Ntot #>65 old
Na = Ntot - Nc - Ne #everyone between 18 and 65
C_prop = Nc/Ntot
A_prop = Na/Ntot
E_prop = Ne/Ntot
```

### Hospitalization and critical care risks

We assume that among those that are cases (i.e. infected and tested positive), 0.1% - 1% under 18 year old, 1% - 10% 18-64 year old and 15% - 25% elderly (>65y) require hospitalization. 
Among those hospitalized, we assume 1% - 10% under 18 year old, 5% - 15% 18-64 year old and 25% - 50% elderly (>65y) require critical care. This is based on [@wu2020; @ferguson20; @remuzzi2020].


```{r parameters-2, include=FALSE}
C_hosp_low = 0.001
A_hosp_low = 0.01
E_hosp_low = 0.15
C_hosp_high = 0.01
A_hosp_high = 0.1
E_hosp_high = 0.25
C_crit_low = 0.01
A_crit_low = 0.05
E_crit_low = 0.25
C_crit_high = 0.1
A_crit_high = 0.15
E_crit_high = 0.50
```


### Fraction deaths among hospitalized
* [@wu2020a] estimate that 14% hospitalized die.

CURRENTLY NOT LOOKING AT DEATHS, SHOULD WE?

### Length of hospital stay
We assume that a hospital stay is between 10 - 20 days and independent of age. This is based on the following data:

* [@guan2020] report 12 days duration of hospitalization for China.
* [@tindale2020] report 13.3 days
* [@sanche2020] find 11.5 days to discharge, 11.2 to death for China.


```{r parameters-3, include=FALSE}
hosp_time_low = 10
hosp_time_high = 20
crit_time_low = 10
crit_time_high = 20
```




## Model results

```{r computations, include=FALSE}

res = list() #save results as list
for (n1 in 1:length(sims)) #looping over all scenarios
{
 x = sims[[n1]]
 res2 = list() #results from each stochastic replicate
 for (n2 in 1:length(x)) #loop over each stochastic replicate simulation for a given scenario
 {
   y = x[[n2]]
   report.times <- seq(1,(length(y$cum.time)), by=20) #daily data
   #use notified cases as basis for hospitalizations
   #this has a few day time lag between a person being diagnosed
   Ctotdaily = y$C[report.times] #total number of cases
   Cnewdaily = diff(Ctotdaily) #daily number of new cases
   
   #new hospitalizations
   #assuming specific proportions of children/adults/elderly and associated risks   
   Hosp_new_low = Cnewdaily*(C_prop*C_hosp_low + A_prop*A_hosp_low + E_prop*E_hosp_low)  
   Hosp_new_high = Cnewdaily*(C_prop*C_hosp_high + A_prop*A_hosp_high + E_prop*E_hosp_high)

   #total hospitalization, is the cumulative of the last hosp_time days of new hospitalizations
   Hosp_tot_low = rep(0,length(Hosp_new_low))
   Hosp_tot_high = Hosp_tot_low
   for (n3 in 1:length(Hosp_new_low))
   {
      Hosp_tot_low[n3] = sum(Hosp_new_low[max(1,n3-hosp_time_low):n3])
      Hosp_tot_high[n3] = sum(Hosp_new_high[max(1,n3-hosp_time_high):n3]) 
   }
   
   #new critical cases
   #assuming specific proportions of children/adults/elderly and associated critical risks   
   Crit_new_low = Hosp_new_low*(C_prop*C_crit_low + A_prop*A_crit_low + E_prop*E_crit_low)  
   Crit_new_high = Hosp_new_high*(C_prop*C_crit_high + A_prop*A_crit_high + E_prop*E_crit_high)

   #total critical, is the cumulative of the last crit_time days of new critical
   Crit_tot_low = rep(0,length(Crit_new_low))
   Crit_tot_high = Crit_tot_low
   for (n3 in 1:length(Crit_new_low))
   {
      Crit_tot_low[n3] = sum(Crit_new_low[max(1,n3-crit_time_low):n3])
      Crit_tot_high[n3] = sum(Crit_new_high[max(1,n3-crit_time_high):n3]) 
   }
 
    
   #save result for each stochastic simulations    
   dat = round(data.frame(Hosp_new_low, Hosp_new_high, Hosp_tot_low, Hosp_tot_high, Crit_new_low, Crit_new_high, Crit_tot_low, Crit_tot_high))
   
   res2[[n2]] = dat    
   
 } #end loop over stochastic replicates
 # save results
 res[[n1]] = res2 
} #end loop over scenarios
```



```{r tablecomputation, include=FALSE}
#dates for all. Assume hospitalizations are 5 days delayed from case notifications, critical is same as hospital
Dates = seq(from = startdate, to = (startdate+length(Crit_new_low)-1), "days" ) 
tab = list()
for (n1 in 1:length(sims)) #looping over all scenarios
{
  x = res[[n1]] #pull out each scenario
  for (n2 in 1:length(x)) #loop over all realizations, compute means
  {
    if (n2 == 1){ xt = x[[n2]]} else {xt = xt + x[[n2]] }     
  }
  xt = round(xt/length(x))
  tab[[n1]] = data.frame(Dates, xt)
} #end loop over scenarios
```

Tables with predictions for different infection spread scenarios.

Results show predicted hospitalizations and critical care needs.
For each variable, a low and high prediction is produced. Each variable is also reported as new cases for a given day and the total cases in that state at any given date.

### ```r scenarios$Description[[1]]```

```{r table1}
ft <- flextable::autofit(flextable::flextable(tab[[1]]))
ft
```

### ```r scenarios$Description[[3]]```

```{r table2}
ft <- flextable::autofit(flextable::flextable(tab[[3]]))
ft
```


## Comments

* See [@li2020] for a similar analysis
* See also propublica: https://projects.propublica.org/graphics/covid-hospitals


## References

