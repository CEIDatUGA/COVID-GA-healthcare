---
title: "Scenario analysis for healthcare needs for COVID-19 in Georgia"
author: "Andreas Handel (ahandel@uga.edu), John M. Drake (jdrake@uga.edu)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
  - \usepackage{amsmath}
output:
  html_document:
    df_print: paged
    self_contained: true
bibliography: ["COVID-GA.bib"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=FALSE, warning=FALSE)
library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(flextable)
```


```{r loaddata, include=FALSE}
# pull data directly from github repo
# data is generated by stochastic GA simulator

# data is a list of lists
# main list contains a sub-list for each scenario
# each sub-list contains n data frames, each data frame is the time-series for a simulation
scenariofile = 'https://raw.githubusercontent.com/CEIDatUGA/ncov-wuhan-stochastic-model/master/Georgia%20scenarios%20-%20Sheet1.csv?token=AA6F3ZKMORB6XSHDU4AFT4S6QM7LC'
#scenariofile <- 'Georgia scenarios - Sheet1.csv'
#simfile = "https://github.com/CEIDatUGA/ncov-wuhan-stochastic-model/blob/master/simresults.rds?token=AA6F3ZKMORB6XSHDU4AFT4S6QM7LC" 
simfile = "simresults.rds" #for some reason, pulling this file right out of the Github repo doesn't work
scenarios = read.csv(scenariofile)
allsims <- readRDS(simfile)
startdate = allsims$startdate
allsims$startdate = NULL #remove so rest of code works
sims = allsims
```


```{r styles}
#source('style-definitions.R')
```

## Introduction

The following produces predictions for health care needs in GA for COVID-19.
The basis for this is a transmission simulation model, which is described here:
http://2019-coronavirus-tracker.com/stochastic-GA.html

The transmission simulation model is run for different intervention scenarios. Output from this model is further processed here to produce estimates for health care needs in GA.


## Assumptions

Below are assumptions with high and low values for different quantities that go into the model predictions.

### Age structure for GA

```{r parameters-1, include=FALSE}
#age structure of population
#https://www.census.gov/quickfacts/GA
Ntot = 10617423
Nc = 2526947 #under 18 (children)
Ne = 1017935 # (elderly)
Nve = 784892 # (very elderly)
Na = Ntot - Nc - Ne #everyone between 18 and 65 (adults)
C_prop = Nc/Ntot
A_prop = Na/Ntot
E_prop = Ne/Ntot
VE_prop = Nve/Ntot
```

We use the data below for population composition of GA. This age stratification is used below for risk calculations. 

* Total population: `r format(Ntot, scientific=FALSE)` 
* Under 18y: `r format(Nc, scientific=FALSE)`
* Between 18-60y: `r format(Na, scientific=FALSE)`
* Between 60-70y: `r format(Ne, scientific=FALSE)`
* Above 70y: `r format(Nve, scientific=FALSE)`



### Hospitalization risk

```{r parameters-hosp, include=FALSE}
#these are proportions
C_death_low = 0.001
C_death_high = 0.01
A_death_low = 0.01
A_death_high = 0.1
E_death_low = 0.10
E_death_high = 0.25
VE_death_low = 0.20
VE_death_high = 0.50
```


We assume that **among those that are cases (i.e. infected and tested positive)**, risk of hospitalization is as follows. This is based on [@wu2020; @ferguson20; @remuzzi2020]. The first number is a low estimate, the second number a high end estimate. All values are percent.

* Under 18y: `r sprintf("%.2f%%/%.2f%%",C_death_low*100, C_death_high*100)`
* Between 18-60y: `r sprintf("%.2f%%/%.2f%%",A_death_low*100, A_death_high*100)`
* Between 60-70y: `r sprintf("%.2f%%/%.2f%%",E_death_low*100, E_death_high*100)`
* Above 70y: `r sprintf("%.2f%%/%.2f%%",VE_death_low*100, VE_death_high*100)`



### Critical Care Risk 

```{r parameters-crit, include=FALSE}
C_crit_low = 0.01
C_crit_high = 0.1
A_crit_low = 0.05
A_crit_high = 0.15
E_crit_low = 0.20
E_crit_high = 0.40
VE_crit_low = 0.40
VE_crit_high = 0.70
```


We assume that **among those that are hospitalized**, risk of critical care need is as follows. This is based on [@wu2020; @ferguson20; @remuzzi2020]. The first number is a low estimate, the second number a high end estimate:

* Under 18y: `r sprintf("%.2f%%/%.2f%%",C_crit_low*100, C_crit_high*100)`
* Between 18-60y: `r sprintf("%.2f%%/%.2f%%",A_crit_low*100, A_crit_high*100)`
* Between 60-70y: `r sprintf("%.2f%%/%.2f%%",E_crit_low*100, E_crit_high*100)`
* Above 70y: `r sprintf("%.2f%%/%.2f%%",VE_crit_low*100, VE_crit_high*100)`




### Risk of death


```{r parameters-death, include=FALSE}
C_death_low = 0.00005
C_death_high = 0.0001
A_death_low = 0.001
A_death_high = 0.01
E_death_low = 0.02
E_death_high = 0.08
VE_death_low = 0.05
VE_death_high = 0.20
```


We assume that **among cases**, risk of death is as follows. This is based on [@verity2020]. The first number is a low estimate, the second number a high end estimate:

* Under 18y: `r sprintf("%.2f%%/%.2f%%",C_death_low*100, C_death_high*100)`
* Between 18-60y: `r sprintf("%.2f%%/%.2f%%",A_death_low*100, A_death_high*100)`
* Between 60-70y: `r sprintf("%.2f%%/%.2f%%",E_death_low*100, E_death_high*100)`
* Above 70y: `r sprintf("%.2f%%/%.2f%%",VE_death_low*100, VE_death_high*100)`


### Length of hospital stay
We assume that a hospital stay is between 10 (low) and 20 (high) days and independent of age. This is based on [@guan2020; @tindale2020; @sanche2020].


```{r parameters-3, include=FALSE}
hosp_time_low = 10
hosp_time_high = 20
crit_time_low = 10
crit_time_high = 20
```



```{r computations, include=FALSE}

res = list() #save results as list
for (n1 in 1:length(sims)) #looping over all scenarios
{
 x = sims[[n1]]
 res2 = list() #results from each stochastic replicate
 for (n2 in 1:length(x)) #loop over each stochastic replicate simulation for a given scenario
 {
   y = x[[n2]]
   report.times <- seq(1,(length(y$cum.time)), by=20) #daily data
   #use notified cases as basis for hospitalizations
   #this has a few day time lag between a person being diagnosed
   Ctotdaily = y$C[report.times] #total number of cases
   Cnewdaily = diff(Ctotdaily) #daily number of new cases
   
   #new hospitalizations
   #assuming specific proportions of children/adults/elderly and associated risks   
   Hosp_new_low = Cnewdaily*(C_prop*C_death_low + A_prop*A_death_low + E_prop*E_death_low + VE_prop*VE_death_low)  
   Hosp_new_high = Cnewdaily*(C_prop*C_death_high + A_prop*A_death_high + E_prop*E_death_high + VE_prop*VE_death_high) 

   #total hospitalization, is the cumulative of the last hosp_time days of new hospitalizations
   Hosp_tot_low = rep(0,length(Hosp_new_low))
   Hosp_tot_high = Hosp_tot_low
   for (n3 in 1:length(Hosp_new_low))
   {
      Hosp_tot_low[n3] = sum(Hosp_new_low[max(1,n3-hosp_time_low):n3])
      Hosp_tot_high[n3] = sum(Hosp_new_high[max(1,n3-hosp_time_high):n3]) 
   }
   
   #new critical cases
   #assuming specific proportions of children/adults/elderly and associated critical risks   
   Crit_new_low = Cnewdaily*(C_prop*C_death_low*C_crit_low + A_prop*A_death_low*A_crit_low + E_prop*E_death_low*E_crit_low + VE_prop*VE_death_low*VE_crit_low)  
   Crit_new_high = Cnewdaily*(C_prop*C_death_high*C_crit_high + A_prop*A_death_high*A_crit_high + E_prop*E_death_high*E_crit_high + VE_prop*VE_death_high*VE_crit_high)

   #total critical, is the cumulative of the last crit_time days of new critical
   Crit_tot_low = rep(0,length(Crit_new_low))
   Crit_tot_high = Crit_tot_low
   for (n3 in 1:length(Crit_new_low))
   {
      Crit_tot_low[n3] = sum(Crit_new_low[max(1,n3-crit_time_low):n3])
      Crit_tot_high[n3] = sum(Crit_new_high[max(1,n3-crit_time_high):n3]) 
   }

   #new deaths - should be lagged
   Dead_new_low = Cnewdaily*(C_prop*C_death_low + A_prop*A_death_low + E_prop*E_death_low + VE_prop*VE_death_low)  
   Dead_new_high = Cnewdaily*(C_prop*C_death_high + A_prop*A_death_high + E_prop*E_death_high + VE_prop*VE_death_high) 
   
   #total hospitalization, is the cumulative of the last hosp_time days of new hospitalizations
   Dead_tot_low = cumsum(Dead_new_low)
   Dead_tot_high = cumsum(Dead_new_high)
    
   #save result for each stochastic simulations    
   dat = round(data.frame(Hosp_new_low, Hosp_new_high, Hosp_tot_low, Hosp_tot_high, Crit_new_low, Crit_new_high, Crit_tot_low, Crit_tot_high, Dead_new_low, Dead_new_high, Dead_tot_low, Dead_tot_high))
   
   res2[[n2]] = dat    
   
 } #end loop over stochastic replicates
 # save results
 res[[n1]] = res2 
} #end loop over scenarios
```



```{r meancomputation, include=FALSE}
#dates for all. Assume hospitalizations are t_delay days delayed from case notifications, critical is same as hospital
#deaths should probably be lagged further, are currently not
t_delay = 5
Dates = seq(from = startdate + t_delay, to = (startdate + t_delay + length(Crit_new_low)-1), "days" ) 
dat = list()
for (n1 in 1:length(sims)) #looping over all scenarios
{
  x = res[[n1]] #pull out each scenario
  for (n2 in 1:length(x)) #loop over all realizations, compute means
  {
    if (n2 == 1){ xt = x[[n2]]} else {xt = xt + x[[n2]] }     
  }
  xt = round(xt/length(x))
 dat[[n1]] = data.frame(Dates, xt)
} #end loop over scenarios
#write computed results to file
saveRDS(dat,'healthcareresults.rds')
```


## Model results

Figures and Tables with predictions for different infection spread scenarios. See [here](http://2019-coronavirus-tracker.com/stochastic-GA.html) for more details on each scenario.

Results show predicted hospitalizations and critical care needs.
For each variable, a low and high prediction is produced. Each variable is also reported as new individuals entering a given state (hospitalized/critical/etc.) at any given day and the total number of individuals in that state at any given date.

```{r figure-fct, include = FALSE}
#function to generate figure for a given scenario
makefigure <- function(scenario, data)
{
   nowdat = data[[scenario]]
   plotdat <-  nowdat %>% tidyr::pivot_longer(-Dates, names_to = "Setting", values_to = "Numbers" ) 
   plotdat <- plotdat %>% mutate(Type = factor(stringr::str_sub(plotdat$Setting,1,8),  levels = c("Hosp_new","Hosp_tot","Crit_new","Crit_tot","Dead_new","Dead_tot") ) )  
   plotdat <- plotdat %>% mutate(H_or_L = as.factor(stringr::str_sub(plotdat$Setting,10)) )  
   pl <- plotdat %>% ggplot()  + 
                     geom_line(aes(x=Dates,y=Numbers,color=H_or_L)) + 
                     facet_wrap(~Type,ncol = 2, scales = "free") +
                     theme(legend.position = "none") +
                     theme_bw() 
   #pl <- ggplotly(pl)
   return(pl)
}
```

```{r table-fct, include = FALSE}
#function to generate table for a given scenario
maketable <- function(scenario, data)
{
   nowdat = data[[scenario]]
   ft <- flextable::autofit(flextable::flextable(nowdat))
   return(ft)   
}
```



```{r setscenario}
scenario = 9
```

### Results for scenario `r scenario`

**Scenario description**

`r scenarios$Description[[scenario]]`.


**Result Figure**

```{r figure1}
fig <- makefigure(scenario = scenario, data = dat)
fig
```

```{r }
scenario = 11
```

### Results for scenario `r scenario`


**Scenario description**

`r scenarios$Description[[scenario]]`.


**Result Figure**

```{r }
fig <- makefigure(scenario = scenario, data = dat)
fig
```


```{r, include = FALSE }
#**Result Table**
#ft <- maketable(scenario = scenario, data = dat)
#ft
```



<!-- ## Comments -->

<!-- * See [@li2020] for a similar analysis -->
<!-- * See also propublica: https://projects.propublica.org/graphics/covid-hospitals -->


## References

