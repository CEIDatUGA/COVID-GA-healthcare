---
title: "Scenario analysis for healthcare needs for COVID-19 in Georgia"
author: "Andreas Handel (ahandel@uga.edu)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
  - \usepackage{amsmath}
output:
  html_document:
    df_print: paged
    self_contained: true
bibliography: ["COVID-GA.bib"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=FALSE, warning=FALSE)
library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(flextable)
```


```{r loaddasedata, include=FALSE}
#actual data
#data <- read.csv('https://raw.githubusercontent.com/CEIDatUGA/COVID-19-DATA/master/GA_daily_status_report_GDPH.csv?token=ABQMQXYHNZXBU7W3UPEIJCS6QKTCE')
data <- read.csv('GA_daily_status_report_GDPH.csv')
data$date <- as.Date(data$date, format='%m/%d/%y')
covid_ga_data <- data %>% tidyr::replace_na(list(cases_cumulative = 0, fatalities_cumulative = 0)) %>%
                          dplyr::mutate(days = 1:nrow(data)) %>% 
                          dplyr::mutate(deaths_cumulative  = fatalities_cumulative) %>%
                          dplyr::mutate(deaths_new = c(0,diff(deaths_cumulative))) %>% 
                          dplyr::mutate(cases_new = c(0,diff(cases_cumulative))) %>% 
                          dplyr::select(date, cases_new, cases_cumulative, deaths_new, deaths_cumulative) 
```


```{r loadsimdata, include=FALSE}
# simulated predictions based on stochastic model 
# pull data directly from github repo
# data is generated by stochastic GA simulator
# data is a list of lists
# main list contains a sub-list for each scenario
# each sub-list contains n data frames, each data frame is the time-series for a simulation
#scenariofile = 'https://raw.githubusercontent.com/CEIDatUGA/ncov-wuhan-stochastic-model/master/Georgia%20scenarios%20-%20Sheet1.csv?token=AA6F3ZKMORB6XSHDU4AFT4S6QM7LC'
scenariofile <- 'COVID scenarios - Georgia.csv'
#simfile = "https://github.com/CEIDatUGA/ncov-wuhan-stochastic-model/blob/master/simresults.rds?token=AA6F3ZKMORB6XSHDU4AFT4S6QM7LC" 
simfile = "simresults.rds" #for some reason, pulling this file right out of the Github repo doesn't work
scenarios = read.csv(scenariofile)
allsims <- readRDS(simfile)
startdate = allsims$startdate
allsims$startdate = NULL #remove so rest of code works
sims = allsims
```


```{r styles}
#source('style-definitions.R')
```

## Introduction

The following produces predictions for health care needs in GA for COVID-19.
The basis for this is a transmission simulation model developed and tuned by John M. Drake (jdrake@uga.edu), which is described here:
http://2019-coronavirus-tracker.com/stochastic-GA.html

The transmission simulation model is run for different intervention scenarios. Output from this model is further processed here to produce estimates for health care needs in GA.


## Assumptions

Below are assumptions with high and low values for different quantities that go into the model predictions.

### Age structure for GA

```{r parameters-1, include=FALSE}
#age structure of population
#https://www.census.gov/quickfacts/GA
Ntot = 10617423
Nc = 2526947 #under 18 (children)
Ne = 1017935 # (elderly)
Nve = 784892 # (very elderly)
Na = Ntot - Nc - Ne #everyone between 18 and 65 (adults)
C_prop = Nc/Ntot
A_prop = Na/Ntot
E_prop = Ne/Ntot
VE_prop = Nve/Ntot
```

We use the data below for population composition of GA. This age stratification is used below for risk calculations. 

* Total population: `r format(Ntot, scientific=FALSE)` 
* Under 18y: `r format(Nc, scientific=FALSE)`
* Between 18-60y: `r format(Na, scientific=FALSE)`
* Between 60-70y: `r format(Ne, scientific=FALSE)`
* Above 70y: `r format(Nve, scientific=FALSE)`



### Hospitalization risk

```{r parameters-hosp, include=FALSE}
#these are proportions
C_hosp_low = 0.001
C_hosp_high = 0.01
A_hosp_low = 0.01
A_hosp_high = 0.1
E_hosp_low = 0.10
E_hosp_high = 0.25
VE_hosp_low = 0.20
VE_hosp_high = 0.50
```


We assume that **among those that are cases (i.e. infected and tested positive)**, risk of hospitalization is as follows. This is based on [@wu2020; @ferguson20; @remuzzi2020]. The first number is a low estimate, the second number a high end estimate. All values are percent.

* Under 18y: `r sprintf("%.2f%%/%.2f%%",C_hosp_low*100, C_hosp_high*100)`
* Between 18-60y: `r sprintf("%.2f%%/%.2f%%",A_hosp_low*100, A_hosp_high*100)`
* Between 60-70y: `r sprintf("%.2f%%/%.2f%%",E_hosp_low*100, E_hosp_high*100)`
* Above 70y: `r sprintf("%.2f%%/%.2f%%",VE_hosp_low*100, VE_hosp_high*100)`



### Critical Care Risk 

```{r parameters-crit, include=FALSE}
C_crit_low = 0.01
C_crit_high = 0.1
A_crit_low = 0.05
A_crit_high = 0.15
E_crit_low = 0.20
E_crit_high = 0.40
VE_crit_low = 0.40
VE_crit_high = 0.70
```


We assume that **among those that are hospitalized**, risk of critical care need is as follows. This is based on [@wu2020; @ferguson20; @remuzzi2020]. The first number is a low estimate, the second number a high end estimate:

* Under 18y: `r sprintf("%.2f%%/%.2f%%",C_crit_low*100, C_crit_high*100)`
* Between 18-60y: `r sprintf("%.2f%%/%.2f%%",A_crit_low*100, A_crit_high*100)`
* Between 60-70y: `r sprintf("%.2f%%/%.2f%%",E_crit_low*100, E_crit_high*100)`
* Above 70y: `r sprintf("%.2f%%/%.2f%%",VE_crit_low*100, VE_crit_high*100)`




### Risk of death


```{r parameters-death, include=FALSE}
C_death_low = 0.00005
C_death_high = 0.0001
A_death_low = 0.001
A_death_high = 0.01
E_death_low = 0.02
E_death_high = 0.08
VE_death_low = 0.05
VE_death_high = 0.20
```


We assume that **among cases**, risk of death is as follows. This is based on [@verity2020]. The first number is a low estimate, the second number a high end estimate:

* Under 18y: `r sprintf("%.3f%%/%.3f%%",C_death_low*100, C_death_high*100)`
* Between 18-60y: `r sprintf("%.2f%%/%.2f%%",A_death_low*100, A_death_high*100)`
* Between 60-70y: `r sprintf("%.2f%%/%.2f%%",E_death_low*100, E_death_high*100)`
* Above 70y: `r sprintf("%.2f%%/%.2f%%",VE_death_low*100, VE_death_high*100)`


### Length of hospital stay
We assume that a hospital stay is between 10 (low) and 20 (high) days and independent of age. This is based on [@guan2020; @tindale2020; @sanche2020].


```{r parameters-3, include=FALSE}
hosp_time_low = 10
hosp_time_high = 20
crit_time_low = 10
crit_time_high = 20
```


### Lag times

```{r parameters-4, include=FALSE}
hosp_delay = 1
death_delay = 2
```


The current assumption is that a case becomes hospitalized or critical `r hosp_delay` days after identification as a case. The lag from case identification to death is assumed to be `r death_delay` days. This reflect the situation in the early stages of the pandemic in GA. As testing ramps up, diagnosis will likely occur earlier and thus the time between diagnosis and hospitalization/death will increase. We will adjust as new data becomes available.



```{r computations, include=FALSE}

res = list() #save results as list
for (n1 in 1:length(sims)) #looping over all scenarios
{
 x = sims[[n1]]
 res2 = list() #results from each stochastic replicate
 for (n2 in 1:length(x)) #loop over each stochastic replicate simulation for a given scenario
 {
   y = x[[n2]]
   report.times <- seq(1,(length(y$cum.time)), by=20) #daily data
   #use notified cases as basis for hospitalizations
   #this has a few day time lag between a person being diagnosed
   Ctotdaily = y$C[report.times] #total number of cases
   Cnewdaily = diff(Ctotdaily) #daily number of new cases
   
   #new hospitalizations
   #assuming specific proportions of children/adults/elderly and associated risks   
   Hosp_new_low = Cnewdaily*(C_prop*C_hosp_low + A_prop*A_hosp_low + E_prop*E_hosp_low + VE_prop*VE_hosp_low)  
   Hosp_new_high = Cnewdaily*(C_prop*C_hosp_high + A_prop*A_hosp_high + E_prop*E_hosp_high + VE_prop*VE_hosp_high) 

   #total hospitalization, is the cumulative of the last hosp_time days of new hospitalizations
   Hosp_tot_low = rep(0,length(Hosp_new_low))
   Hosp_tot_high = Hosp_tot_low
   for (n3 in 1:length(Hosp_new_low))
   {
      Hosp_tot_low[n3] = sum(Hosp_new_low[max(1,n3-hosp_time_low):n3])
      Hosp_tot_high[n3] = sum(Hosp_new_high[max(1,n3-hosp_time_high):n3]) 
   }
   
   #new critical cases
   #assuming specific proportions of children/adults/elderly and associated critical risks   
   Crit_new_low = Cnewdaily*(C_prop*C_hosp_low*C_crit_low + A_prop*A_hosp_low*A_crit_low + E_prop*E_hosp_low*E_crit_low + VE_prop*VE_hosp_low*VE_crit_low)  
   Crit_new_high = Cnewdaily*(C_prop*C_hosp_high*C_crit_high + A_prop*A_hosp_high*A_crit_high + E_prop*E_hosp_high*E_crit_high + VE_prop*VE_hosp_high*VE_crit_high)

   #total critical, is the cumulative of the last crit_time days of new critical
   Crit_tot_low = rep(0,length(Crit_new_low))
   Crit_tot_high = Crit_tot_low
   for (n3 in 1:length(Crit_new_low))
   {
      Crit_tot_low[n3] = sum(Crit_new_low[max(1,n3-crit_time_low):n3])
      Crit_tot_high[n3] = sum(Crit_new_high[max(1,n3-crit_time_high):n3]) 
   }

   #new deaths - should be lagged
   Dead_new_low = Cnewdaily*(C_prop*C_death_low + A_prop*A_death_low + E_prop*E_death_low + VE_prop*VE_death_low)  
   Dead_new_high = Cnewdaily*(C_prop*C_death_high + A_prop*A_death_high + E_prop*E_death_high + VE_prop*VE_death_high) 
   
   #total hospitalization, is the cumulative of the last hosp_time days of new hospitalizations
   Dead_tot_low = cumsum(Dead_new_low)
   Dead_tot_high = cumsum(Dead_new_high)
    
   #save result for each stochastic simulations    
   dat = round(data.frame(Case_new = Cnewdaily, Case_tot = Ctotdaily[-1], Hosp_new_low, Hosp_new_high, Hosp_tot_low, Hosp_tot_high, Crit_new_low, Crit_new_high, Crit_tot_low, Crit_tot_high, Dead_new_low, Dead_new_high, Dead_tot_low, Dead_tot_high))
   
   res2[[n2]] = dat    
   
 } #end loop over stochastic replicates
 # save results
 res[[n1]] = res2 
} #end loop over scenarios
```



```{r meancomputation, include=FALSE}
#dates for all. Assume hospitalizations are t_delay days delayed from case notifications, critical is same as hospital
#deaths should probably be lagged further, are currently not
Dates = seq(from = startdate, to = (startdate + length(Crit_new_low)-1) + death_delay, "days" ) 
dat = list()
for (n1 in 1:length(sims)) #looping over all scenarios
{
  x = res[[n1]] #pull out each scenario
  for (n2 in 1:length(x)) #loop over all realizations, compute means
  {
    if (n2 == 1){ xt = x[[n2]]} else {xt = xt + x[[n2]] }     
  }
  xt = round(xt/length(x))
  #run over each outcome column in xt, add to data frame time-shifted to account for delays
  df = array(0, dim=c(length(Dates), ncol(xt) )) #empty data frame
  for (n2 in 1:ncol(xt))
  {
     if (n2<3) #cases, no time lag
        { 
          df[1:nrow(xt),n2] = xt[,n2]
        }
     if (n2>2 && n2 <11) #hosp and crit, 7 day time lag
        { 
          df[(1+hosp_delay):(nrow(xt)+hosp_delay),n2] = xt[,n2]
        }
     if (n2>10 ) #death, 14 day time lag
        { 
          df[(1+death_delay):(nrow(xt)+death_delay),n2] = xt[,n2]
        }
  }
  colnames(df) = colnames(xt)
  
  dat[[n1]] = data.frame(Dates, df)
 
} #end loop over scenarios
#write computed results to file
saveRDS(dat,'healthcareresults.rds')
```



```{r figure-fct, include = FALSE}
#function to generate figure for a given scenario
makefigure <- function(dat)
{
   typelevels = c("Case_new","Case_tot","Hosp_new","Hosp_tot","Crit_new","Crit_tot","Dead_new","Dead_tot")
   plotdat <- dat %>% tidyr::pivot_longer(-Dates, names_to = "Setting", values_to = "Numbers" ) 
   plotdat <- plotdat %>% mutate(Type = factor(stringr::str_sub(plotdat$Setting,1,8),  levels = typelevels ) )  
   plotdat <- plotdat %>% mutate(H_or_L = as.factor(stringr::str_sub(plotdat$Setting,10)) )  
   pl = list()
   for (n in 1:8)
   {
      pl[[n]] <- plotdat %>% filter(Type == typelevels[n] ) %>% ggplot()  + 
                     geom_line(aes(x=Dates,y=Numbers,color=H_or_L), show.legend = FALSE, size = 1) + scale_y_log10() +
                     ggtitle(typelevels[n]) + xlim(startdate,startdate + length(Crit_new_low)-1) +
                     theme_minimal() 
      if (n == 1) #add actual data to plot                  
      {   
         pl[[n]] <- pl[[n]] + geom_point(aes(x=date, y = cases_new), data = covid_ga_data)        
      }
      if (n == 2) #add actual data to plot                  
      {   
         pl[[n]] <- pl[[n]] + geom_point(aes(x=date, y = cases_cumulative), data = covid_ga_data)        
      }
      if (n == 7) #add actual data to plot                  
      {   
         pl[[n]] <- pl[[n]] + geom_point(aes(x=date, y = deaths_new), data = covid_ga_data)        
      }
      if (n == 8) #add actual data to plot                  
      {   
         pl[[n]] <- pl[[n]] + geom_point(aes(x=date, y = deaths_cumulative), data = covid_ga_data)        
      }
   }
   allpl <- pl[[1]] + pl[[2]] + pl[[3]] + pl[[4]] + pl[[5]] + pl[[6]] + pl[[7]] + pl[[8]] + plot_layout(ncol = 2) 
   return(allpl)
}
```

```{r table-fct, include = FALSE}
#function to generate table for a given scenario
maketable <- function(dat)
{
   ft <- flextable::autofit(flextable::flextable(dat))
   return(ft)   
}
```


## Model results

Figures and Tables with predictions for different infection spread scenarios. See [here](http://2019-coronavirus-tracker.com/stochastic-GA.html) for more details on each scenario.

Results show predicted hospitalizations and critical care needs. For each variable, a low and high prediction is produced. Each variable is reported both as new individuals entering a given state (hospitalized/critical/etc.) at any given day and the total number of individuals in that state at any given date. The total hospital and critical care capacity needs for a given day take into account both new individuals entering and those leaving (due to recovery or death).

The transmission simulation is run from `r startdate` to `r startdate + length(Crit_new_low)-1`, this is the reporting time-frame for cases. Hospitalizations and critical care numbers are assumed to lag case ascertainment by `r hosp_delay` days. Death is assumed to lag by `r death_delay` days. This is likely not true during the first few weeks, when a lot of diagnoses were only made after someone had already been in the hospital, or had died. Thus, for most of March, hospitalizations and deaths on a given day might be under-predicted. We assume that going forward, as test capacity keeps increasing, most individuals will be diagnosed before hospitalization or death.


```{r setscenario-9}
scenario = 9
```

### Results for scenario `r scenario`

**Scenario description**

`r scenarios$Description[[scenario]]`.

**Result Figure**

The left column show daily new individuals. The right column shows total numbers at a given date. Note that recovery of cases is not included here, thus cases keep increasing. Cases are the average predicted from the stochastic simulation model.


```{r figure-s9, out.width = "100%", fig.height=10}
fig <- makefigure(dat[[scenario]])
fig
```



```{r setscenario-15}
scenario = 16
```

### Results for scenario `r scenario`

**Scenario description**

`r scenarios$Description[[scenario]]`.

**Result Figure**

The left column show daily new individuals. The right column shows total numbers at a given date. Note that recovery of cases is not included here, thus cases keep increasing. Cases are the average predicted from the stochastic simulation model.


```{r figure1, out.width = "100%", fig.height=10}
fig <- makefigure(dat[[scenario]])
fig
```

<!-- **Result Table** -->

<!-- Same results as shown in the figures, but in table form. -->

<!-- Predicted cases and deaths: -->

<!-- ```{r, include = TRUE } -->
<!-- #nowdat = dat[[scenario]] -->
<!-- #table for cases and deaths -->
<!-- #ft1 <- maketable(nowdat[,c(1:3,12:15)]) -->
<!-- #ft1 -->
<!-- ``` -->

<!-- Predicted hospitalizations and critical care needs: -->


<!-- ```{r, include = TRUE } -->
<!-- nowdat = dat[[scenario]] -->
<!-- #table for hosp and critical -->
<!-- #ft2 <- maketable(nowdat[,c(1,4:11)]) -->
<!-- #ft2 -->
<!-- ``` -->



<!-- ## Comments -->

<!-- * See [@li2020] for a similar analysis -->
<!-- * See also propublica: https://projects.propublica.org/graphics/covid-hospitals -->


## References

